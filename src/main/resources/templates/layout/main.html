<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${title} + ' - 管理系统'">管理系统</title>

  <!-- LayUI CSS -->
  <link rel="stylesheet" th:href="@{/layui/css/layui.css}">

  <style>
    /* 布局样式 */
    .layout-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .layout-header {
      background: #23262E;
      color: white;
      height: 60px;
      line-height: 60px;
    }
    .layout-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .layout-side {
      width: 220px;
      background: #2F3341;
    }
    .layout-content {
      flex: 1;
      padding: 15px;
      background: #f5f5f5;
      overflow: auto;
    }
    .logo {
      height: 60px;
      line-height: 60px;
      text-align: center;
      color: white;
      font-size: 18px;
      border-bottom: 1px solid #393D49;
    }

    /* 内容区域样式 */
    .content-card {
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      min-height: calc(100vh - 120px);
    }

    /* 标签页样式 */
    .content-tabs {
      height: 100%;
    }
    .layui-tab-content {
      padding: 0;
      height: calc(100% - 42px);
    }
    .tab-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body class="layout-container">

<!-- 头部区域 -->
<div th:replace="layout/header :: header"></div>

<!-- 主体区域 -->
<div class="layout-body">

  <!-- 左侧菜单 -->
  <div class="layout-side">
    <div th:replace="fragments/menu :: menu"></div>
  </div>

  <!-- 右侧内容区域 -->
  <div class="layout-content">
    <!-- 标签页容器 -->
    <div class="content-tabs">
      <div class="layui-tab layui-tab-brief" lay-filter="content-tabs" lay-allowClose="true">
        <ul class="layui-tab-title">
          <li class="layui-this" lay-id="dashboard">首页</li>
        </ul>
        <div class="layui-tab-content">
          <div class="layui-tab-item layui-show">
            <!-- 首页内容 -->
            <div th:if="${#request.requestURI == '/main'}">
              <div th:replace="pages/dashboard :: dashboard"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 底部区域 -->
<div class="layout-footer">
  <div th:replace="layout/footer :: footer"></div>
</div>

<!-- LayUI JS -->
<script th:src="@{/layui/layui.js}"></script>
<script>
  // 初始化 LayUI
  layui.use(['element', 'jquery'], function(){
    var element = layui.element;
    var $ = layui.$;

    // 标签页管理
    var tabManager = {
      // 添加或切换标签页
      addTab: function(title, url, tabId) {
        // 检查是否已存在
        var existingTab = $('.layui-tab-title li[lay-id="' + tabId + '"]');
        if (existingTab.length > 0) {
          element.tabChange('content-tabs', tabId);
          return;
        }

        // 添加新标签页
        element.tabAdd('content-tabs', {
          title: title,
          content: '<div class="tab-content" data-url="' + url + '">加载中...</div>',
          id: tabId
        });

        // 切换到新标签页
        element.tabChange('content-tabs', tabId);

        // 加载内容
        this.loadTabContent(tabId, url);
      },

      // 加载标签页内容
      loadTabContent: function(tabId, url) {
        var tabContent = $('.layui-tab-item[lay-id="' + tabId + '"] .tab-content');

        $.ajax({
          url: url,
          type: 'GET',
          success: function(data) {
            tabContent.html(data);
          },
          error: function() {
            tabContent.html('<div class="layui-card"><div class="layui-card-body" style="text-align: center; padding: 50px;">页面加载失败</div></div>');
          }
        });
      },

      // 刷新当前标签页
      refreshCurrent: function() {
        var currentTab = $('.layui-tab-title .layui-this');
        var tabId = currentTab.attr('lay-id');
        var tabContent = $('.layui-tab-item.layui-show .tab-content');
        var url = tabContent.data('url');

        if (url) {
          tabContent.html('加载中...');
          this.loadTabContent(tabId, url);
        }
      }
    };

    // 菜单点击事件
    $(document).on('click', '.menu-item[data-url]', function(e){
      e.preventDefault();
      var url = $(this).data('url');
      var title = $(this).data('title') || '未命名';
      var tabId = url.replace(/\//g, '_');

      tabManager.addTab(title, url, tabId);
    });

    // 标签页关闭事件
    element.on('tabDelete(content-tabs)', function(data){
      // 可以在这里处理关闭前的逻辑
    });

    // 初始化首页内容
    tabManager.loadTabContent('dashboard', '/dashboard');
  });
</script>
</body>
</html>
